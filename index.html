<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫ø Ho·∫°ch H·ªçc T·∫≠p To√†n Di·ªán</title>
    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #007bff;
            --border-color: #ddd;
            --background-color: #f0f2f5;
            --card-background: white;
            --text-color: #1c1e21;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .main-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
        }
        .form-container, .schedule-list-container {
            background: var(--card-background);
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
        }
        h1, h2 {
            text-align: center;
            color: var(--primary-color);
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: inherit;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        button#addBtn {
            width: 100%;
            padding: 14px;
            border: none;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button#addBtn:hover { transform: translateY(-2px); }
        #scheduleList {
            list-style-type: none;
            padding: 0;
            max-height: 70vh;
            overflow-y: auto;
        }
        .schedule-item {
            background: #f9f9f9;
            padding: 15px;
            border-left: 5px solid var(--secondary-color);
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .schedule-item.expired { border-left-color: #6c757d; background-color: #e9ecef; }
        .schedule-item.running { border-left-color: #28a745; }
        .schedule-item.done { border-left-color: #17a2b8; }
        .schedule-item .info { flex-grow: 1; overflow: hidden; }
        .schedule-item .datetime { font-weight: bold; font-size: 1.1em; }
        .schedule-item .links-summary { font-size: 0.9em; color: #555; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .schedule-item .actions { display: flex; align-items: center; gap: 10px; }
        .schedule-item .status { font-weight: bold; min-width: 100px; text-align: right; }
        .schedule-item .action-btn { background: none; border: 1px solid var(--border-color); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; }
        .schedule-item .delete-btn { background-color: #dc3545; color: white; border: none; }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 25px; border-radius: 10px; width: 90%; max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: var(--primary-color); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body h4 { margin-top: 20px; margin-bottom: 10px; }
        .modal-body .links-list, .modal-body .checklist { list-style: none; padding-left: 0; }
        .modal-body .links-list li { margin-bottom: 5px; word-break: break-all; }
        .modal-body .notes { background: #f9f9f9; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
        .modal-body .checklist-item { display: flex; align-items: center; margin-bottom: 8px; }
        .modal-body .checklist-item input { width: auto; margin-right: 10px; }
        .modal-body .checklist-item label { text-decoration: none; }
        .modal-body .checklist-item input:checked + label { text-decoration: line-through; color: #888; }
        @keyframes fadeIn { from {opacity: 0; transform: scale(0.9);} to {opacity: 1; transform: scale(1);} }
        .backup-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; display: flex; gap: 15px; }
        .backup-section button { width: 100%; padding: 10px; font-size: 14px; font-weight: bold; cursor: pointer; border-radius: 8px; border: none; }
        #exportBtn { background-color: #17a2b8; color: white; }
        #importBtn { background-color: #28a745; color: white; }
        #importFile { display: none; }
    </style>
</head>
<body>

<div class="main-container">

    <div class="form-container">
        <h1>L·∫≠p K·∫ø Ho·∫°ch H·ªçc T·∫≠p üóìÔ∏è</h1>
        <div class="input-group">
            <label for="studyLinks">Link b√†i h·ªçc (m·ªói link m·ªôt d√≤ng):</label>
            <textarea id="studyLinks" placeholder="https://youtube.com/..." required></textarea>
        </div>
        <div class="input-group">
            <label for="notes">Ghi ch√∫:</label>
            <textarea id="notes" placeholder="N·ªôi dung ch√≠nh, m·ª•c ti√™u c·∫ßn ƒë·∫°t..."></textarea>
        </div>
        <div class="input-group">
            <label for="checklist">Checklist c√¥ng vi·ªác (m·ªói m·ª•c m·ªôt d√≤ng):</label>
            <textarea id="checklist" placeholder="ƒê·ªçc ch∆∞∆°ng 1\nL√†m b√†i t·∫≠p A\nXem l·∫°i video..."></textarea>
        </div>
        <div class="input-group">
            <label for="openDate">Ng√†y h·ªçc:</label>
            <input type="date" id="openDate" required>
        </div>
        <div class="input-group">
            <label for="openTime">Gi·ªù b·∫Øt ƒë·∫ßu:</label>
            <input type="time" id="openTime" required>
        </div>
        <div class="input-group">
            <label for="endTime">Gi·ªù k·∫øt th√∫c:</label>
            <input type="time" id="endTime" required>
        </div>
        <div class="input-group">
            <label for="beginSoundUrl">üéµ Link √¢m b√°o b·∫Øt ƒë·∫ßu:</label>
            <input type="text" id="beginSoundUrl" placeholder="D√°n link √¢m thanh .mp3, .wav...">
        </div>
        <div class="input-group">
            <label for="endSoundUrl">üéµ Link √¢m b√°o k·∫øt th√∫c:</label>
            <input type="text" id="endSoundUrl" placeholder="D√°n link √¢m thanh .mp3, .wav...">
        </div>
        <button id="addBtn" onclick="addSchedule()">Th√™m L·ªãch H·ªçc</button>
        
        <div class="backup-section">
            <button id="exportBtn" onclick="exportSchedulesToFile()">üì• Xu·∫•t File (.json)</button>
            <button id="importBtn" onclick="document.getElementById('importFile').click()">üì§ Nh·∫≠p File (.json)</button>
            <input type="file" id="importFile" accept=".json" onchange="importSchedulesFromFile(event)">
        </div>
    </div>

    <div class="schedule-list-container">
        <h2>Danh S√°ch L·ªãch H·ªçc</h2>
        <ul id="scheduleList"></ul>
    </div>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Chi ti·∫øt l·ªãch h·ªçc</h3>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>

<script>
    let schedules = [];
    let schedulerWorker;

    // === C√ÅC H√ÄM X·ª¨ L√ù POP-UP (MODAL) ===
    function showDetails(id) {
        const schedule = schedules.find(s => s.id === id);
        if (!schedule) return;
        const modal = document.getElementById('detailsModal');
        const modalBody = document.getElementById('modalBody');
        const start = new Date(schedule.startDateTimeString);
        document.getElementById('modalTitle').innerText = `L·ªãch h·ªçc ng√†y ${start.toLocaleDateString('vi-VN')}`;
        let linksHTML = '<h4>üîó Links</h4><ul class="links-list">';
        schedule.links.forEach(link => { linksHTML += `<li><a href="${link}" target="_blank">${link}</a></li>`; });
        linksHTML += '</ul>';
        const notesHTML = `<h4>üìù Ghi ch√∫</h4><div class="notes">${schedule.notes || "Kh√¥ng c√≥ ghi ch√∫."}</div>`;
        let checklistHTML = '<h4>‚úÖ Checklist</h4><div class="checklist">';
        if (schedule.checklist && schedule.checklist.length > 0) {
            schedule.checklist.forEach((item, index) => {
                checklistHTML += `<div class="checklist-item"><input type="checkbox" id="item-${id}-${index}" ${item.done ? 'checked' : ''} onchange="toggleChecklistItem('${id}', ${index})"><label for="item-${id}-${index}">${item.text}</label></div>`;
            });
        } else { checklistHTML += "Kh√¥ng c√≥ checklist."; }
        checklistHTML += '</div>';
        modalBody.innerHTML = linksHTML + notesHTML + checklistHTML;
        modal.style.display = 'flex';
    }
    function closeModal() { document.getElementById('detailsModal').style.display = 'none'; }
    function toggleChecklistItem(scheduleId, itemIndex) {
        const schedule = schedules.find(s => s.id === scheduleId);
        if (schedule && schedule.checklist[itemIndex]) {
            schedule.checklist[itemIndex].done = !schedule.checklist[itemIndex].done;
            saveAndRender();
        }
    }

    // === H√ÄM X·ª¨ L√ù √ÇM THANH ===
    function playSound(url) { if (url) { new Audio(url).play(); } }

    // === L∆ØU TR·ªÆ, T·∫¢I, V√Ä X·ª¨ L√ù D·ªÆ LI·ªÜU ===
    function setupWorker() {
        if (window.Worker) {
            schedulerWorker = new Worker('scheduler.worker.js');
            schedulerWorker.onmessage = function(e) {
                const scheduleId = e.data;
                startSession(scheduleId);
            };
        } else {
            alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Workers, ch·ª©c nƒÉng h·∫πn gi·ªù ·ªü tab kh√°c s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.");
        }
    }
    function updateWorker() { if (schedulerWorker) { schedulerWorker.postMessage(JSON.parse(JSON.stringify(schedules))); } }
    function saveSchedules() { localStorage.setItem('mySmartScheduler', JSON.stringify(schedules)); }
    function saveAndRender() { saveSchedules(); renderSchedules(); updateWorker(); }
    function loadAndProcessSchedules() {
        const savedSchedules = localStorage.getItem('mySmartScheduler');
        schedules = savedSchedules ? JSON.parse(savedSchedules) : [];
        const now = new Date();
        schedules.forEach(schedule => {
            if (schedule.status !== 'done' && now >= new Date(schedule.endDateTimeString)) {
                schedule.status = 'done';
            }
        });
        renderSchedules();
        updateWorker();
    }
    function exportSchedulesToFile() {
        if (schedules.length === 0) { alert("Kh√¥ng c√≥ l·ªãch h·ªçc n√†o ƒë·ªÉ xu·∫•t!"); return; }
        const dataStr = JSON.stringify(schedules, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `lich_hoc_${new Date().toISOString().slice(0, 10)}.json`;
        link.click();
        URL.revokeObjectURL(url);
    }
    function importSchedulesFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedSchedules = JSON.parse(e.target.result);
                if (Array.isArray(importedSchedules)) {
                    schedules = importedSchedules;
                    saveSchedules();
                    loadAndProcessSchedules();
                    alert(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${schedules.length} l·ªãch h·ªçc!`);
                } else { throw new Error("Invalid format"); }
            } catch (error) { alert("L·ªói: File kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã h·ªèng."); }
        };
        reader.readAsText(file);
        event.target.value = null;
    }

    // === C√ÅC H√ÄM X·ª¨ L√ù L·ªäCH H·ªåC ===
    function addSchedule() {
        const links = document.getElementById('studyLinks').value.trim().split('\n').filter(link => link.trim() !== '');
        const notes = document.getElementById('notes').value.trim();
        const checklistItems = document.getElementById('checklist').value.trim().split('\n').filter(item => item.trim() !== '').map(text => ({ text: text, done: false }));
        const date = document.getElementById('openDate').value;
        const startTime = document.getElementById('openTime').value;
        const endTime = document.getElementById('endTime').value;
        const beginSound = document.getElementById('beginSoundUrl').value.trim();
        const endSound = document.getElementById('endSoundUrl').value.trim();

        if (links.length === 0 || !date || !startTime || !endTime) { alert("Vui l√≤ng ƒëi·ªÅn link b√†i h·ªçc v√† th·ªùi gian!"); return; }
        const startDateTime = new Date(`${date}T${startTime}`);
        const endDateTime = new Date(`${date}T${endTime}`);
        if (startDateTime >= endDateTime || endDateTime < new Date()) { alert("L·ªói: Th·ªùi gian kh√¥ng h·ª£p l·ªá!"); return; }

        const newSchedule = {
            id: 'schedule-' + Date.now(),
            links: links,
            notes: notes,
            checklist: checklistItems,
            startDateTimeString: startDateTime.toISOString(),
            endDateTimeString: endDateTime.toISOString(),
            status: 'waiting',
            beginSound: beginSound,
            endSound: endSound
        };

        schedules.push(newSchedule);
        saveAndRender();
        ['studyLinks', 'notes', 'checklist', 'openDate', 'openTime', 'endTime', 'beginSoundUrl', 'endSoundUrl'].forEach(id => document.getElementById(id).value = '');
    }

    function deleteSchedule(id) {
        const scheduleIndex = schedules.findIndex(s => s.id === id);
        if (scheduleIndex > -1) {
            clearInterval(schedules[scheduleIndex].countdownInterval);
            schedules.splice(scheduleIndex, 1);
        }
        saveAndRender();
    }
    
    function startSession(id) {
        const schedule = schedules.find(s => s.id === id);
        if (schedule && schedule.status === 'waiting') {
            playSound(schedule.beginSound);
            schedule.links.forEach(link => window.open(link, '_blank'));
            schedule.status = 'running';
            saveAndRender();
        }
    }

    function startCountdown(id, seconds) {
        const schedule = schedules.find(s => s.id === id);
        if (!schedule) return;
        clearInterval(schedule.countdownInterval);
        let timeLeft = Math.round(seconds);
        updateCountdownDisplay(id, timeLeft);
        schedule.countdownInterval = setInterval(() => {
            timeLeft--;
            updateCountdownDisplay(id, timeLeft);
            if (timeLeft <= 0) {
                clearInterval(schedule.countdownInterval);
                playSound(schedule.endSound);
                schedule.status = 'done';
                saveAndRender();
            }
        }, 1000);
    }
    
    // === C√ÅC H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN ===
    function updateCountdownDisplay(id, timeLeft) {
        const itemElement = document.getElementById(id);
        if (!itemElement) return;
        const statusElement = itemElement.querySelector('.status');
        if(!statusElement) return;
        if (timeLeft <= 0) {
            statusElement.innerHTML = "‚úÖ Ho√†n th√†nh!";
        } else {
            const h = Math.floor(timeLeft / 3600).toString().padStart(2, '0');
            const m = Math.floor((timeLeft % 3600) / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            itemElement.classList.remove('done', 'expired', 'waiting');
            itemElement.classList.add('running');
            statusElement.style.color = '#28a745';
            statusElement.innerHTML = `${h}:${m}:${s}`;
        }
    }

    function renderSchedules() {
        const listElement = document.getElementById('scheduleList');
        listElement.innerHTML = '';
        schedules.sort((a, b) => new Date(a.startDateTimeString) - new Date(b.startDateTimeString));
        if (schedules.length === 0) {
            listElement.innerHTML = '<p style="text-align:center; color:#888;">H√£y b·∫Øt ƒë·∫ßu l√™n k·∫ø ho·∫°ch h·ªçc t·∫≠p c·ªßa b·∫°n!</p>';
            return;
        }
        schedules.forEach(schedule => {
            const item = document.createElement('li');
            item.className = 'schedule-item';
            item.id = schedule.id;
            const start = new Date(schedule.startDateTimeString);
            const end = new Date(schedule.endDateTimeString);
            const now = new Date();
            let statusHTML = '';
            item.classList.remove('running', 'done', 'expired');
            if (schedule.status === 'running' || (schedule.status === 'waiting' && now >= start && now < end)) {
                schedule.status = 'running';
                item.classList.add('running');
                const remainingTime = (end.getTime() - now.getTime()) / 1000;
                statusHTML = `<div class="status"></div>`;
                if (remainingTime > 0) startCountdown(schedule.id, remainingTime);
            } else if (schedule.status === 'done' || now >= end) {
                item.classList.add('done');
                statusHTML = `<div class="status" style="color: #17a2b8;">‚úÖ Ho√†n th√†nh!</div>`;
            } else if (start < now) {
                item.classList.add('expired');
                statusHTML = `<div class="status" style="color: #6c757d;">ƒê√£ qua</div>`;
            } else {
                statusHTML = `<div class="status" style="color: var(--secondary-color);">S·∫Øp t·ªõi</div>`;
            }
            const firstLink = schedule.links[0] || "Kh√¥ng c√≥ link";
            const otherLinksCount = schedule.links.length - 1;
            const linkDisplay = otherLinksCount > 0 ? `${firstLink} (+${otherLinksCount})` : firstLink;
            item.innerHTML = `<div class="info"><div class="datetime">${start.toLocaleDateString('vi-VN')} | ${start.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'})}</div><div class="links-summary" title="${schedule.links.join('\n')}">${linkDisplay}</div></div><div class="actions">${statusHTML}<button class="action-btn" title="Xem chi ti·∫øt" onclick="showDetails('${schedule.id}')">üëÅÔ∏è</button><button class="action-btn delete-btn" title="X√≥a" onclick="deleteSchedule('${schedule.id}')">X</button></div>`;
            listElement.appendChild(item);
        });
    }

    // --- KH·ªûI CH·∫†Y ---
    document.addEventListener('DOMContentLoaded', () => {
        setupWorker();
        loadAndProcessSchedules();
        window.onclick = function(event) {
            if (event.target == document.getElementById('detailsModal')) { closeModal(); }
        }
    });
</script>

</body>
</html>
